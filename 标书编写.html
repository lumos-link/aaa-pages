<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标书编写</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tool-panel { 
            transition: all 0.3s;
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slide-out {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        .animate-slide-in {
            animation: slide-in 0.3s ease-out;
        }
        .export-format-option input[type="radio"]:checked + * {
            /* 选中状态的样式 */
        }
        .export-format-option.border-blue-500 {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .typing-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #9ca3af;
            animation: typing 1.4s infinite;
        }
        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <section class="p-6 space-y-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
                <p class="text-xs text-purple-500 font-semibold uppercase tracking-widest mb-2">Step 03</p>
                <h1 class="text-2xl font-semibold text-gray-800">标书编写</h1>
                <p class="text-sm text-gray-500">使用AI写作、格式工具、素材库等功能完成标书内容编写。</p>
            </div>
            <div class="flex items-center gap-3 text-sm flex-wrap justify-end">
                <div class="flex items-center gap-2 text-xs text-gray-500" id="saveStatus">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>已自动保存</span>
                </div>
                <button onclick="manualSave()" class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-save mr-2"></i> 保存
                </button>
                <button class="px-4 py-2 bg-purple-600 text-white rounded-lg" onclick="showExportModal()">
                    <i class="fas fa-download mr-2"></i> 导出
                </button>
            </div>
        </div>

        <div class="grid lg:grid-cols-[280px_1fr] gap-6">
            <div class="space-y-4">
                <!-- 编写情况（可收起） -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="flex items-center justify-between p-3 border-b border-gray-200 cursor-pointer hover:bg-gray-50" onclick="toggleWritingStatus()">
                        <h2 class="text-sm font-semibold text-gray-800">编写情况</h2>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500" id="statusUpdateTime">刚刚</span>
                            <button class="text-xs text-gray-400 hover:text-gray-600" id="statusToggleBtn">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                    </div>
                    <div id="writingStatusContent" class="p-4 space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="text-center p-2 bg-blue-50 rounded-lg">
                                <div class="text-xl font-bold text-blue-600" id="totalChapters">0</div>
                                <div class="text-[10px] text-gray-600 mt-1">总章节数</div>
                            </div>
                            <div class="text-center p-2 bg-green-50 rounded-lg">
                                <div class="text-xl font-bold text-green-600" id="completedChapters">0</div>
                                <div class="text-[10px] text-gray-600 mt-1">已完成</div>
                            </div>
                            <div class="text-center p-2 bg-yellow-50 rounded-lg">
                                <div class="text-xl font-bold text-yellow-600" id="writingChapters">0</div>
                                <div class="text-[10px] text-gray-600 mt-1">编写中</div>
                            </div>
                            <div class="text-center p-2 bg-gray-50 rounded-lg">
                                <div class="text-xl font-bold text-gray-600" id="pendingChapters">0</div>
                                <div class="text-[10px] text-gray-600 mt-1">未开始</div>
                            </div>
                        </div>
                        <div class="border-t border-gray-200 pt-3">
                            <div class="flex items-center justify-between text-xs mb-2">
                                <span class="text-gray-600">整体进度</span>
                                <span class="font-semibold text-gray-800" id="progressPercent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5">
                                <div class="bg-blue-600 h-1.5 rounded-full transition-all" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-sm font-semibold text-gray-800">章节结构</h2>
                        <div class="flex items-center gap-2">
                            <select id="chapterFilter" class="text-xs border border-gray-300 rounded px-2 py-1" onchange="filterChapters()">
                                <option value="all">全部</option>
                                <option value="required">实质项</option>
                                <option value="score">评分相关</option>
                                <option value="pending">未开始</option>
                                <option value="writing">编写中</option>
                                <option value="completed">已完成</option>
                            </select>
                            <button class="text-xs text-blue-600"><i class="fas fa-sync mr-1"></i> 刷新</button>
                        </div>
                    </div>
                    <div id="chapterTree" class="space-y-1 text-sm max-h-[calc(100vh-400px)] overflow-y-auto">
                        <!-- 章节结构将动态生成 -->
                    </div>
                </div>
            </div>

            <div class="flex gap-6">
                <!-- 左侧编辑区域 -->
                <div class="flex-1 space-y-4 min-w-0">
                    <!-- 标书名称显示 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-file-alt text-purple-600"></i>
                            <div>
                                <p class="text-xs text-gray-500">当前标书</p>
                                <h2 class="text-base font-semibold text-gray-800" id="bidName">城市运行数字底座建设项目</h2>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                        <div class="flex flex-col gap-2 mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-gray-700">当前章节：</span>
                                <span class="text-sm text-purple-600 font-semibold" id="currentChapter">请选择章节</span>
                                <span id="chapterRiskBadge" class="hidden px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs">实质项</span>
                            </div>
                            <div class="flex items-center gap-2 flex-wrap text-xs text-gray-500">
                                <button class="px-3 py-1.5 border border-gray-200 rounded text-xs text-gray-600 hover:bg-gray-50" onclick="previewCurrentChapter()">
                                    <i class="fas fa-eye mr-1 text-blue-500"></i> 预览Word格式
                                </button>
                                <button id="confirmChapterBtn" class="px-3 py-1.5 border border-gray-200 rounded text-xs text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="confirmChapterCompletion()">
                                    <i class="fas fa-check-circle mr-1 text-green-500"></i> 标记已完成
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3 p-3 bg-blue-50 border border-blue-100 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-medium text-gray-700">引用企业知识库</label>
                                <button onclick="showKnowledgeModal()" class="text-xs text-blue-600"><i class="fas fa-plus mr-1"></i> 选择</button>
                            </div>
                            <div id="knowledgeList" class="flex flex-wrap gap-2 mt-2">
                                <!-- 已选择的知识库和文件将动态显示 -->
                            </div>
                        </div>

                        <div class="border border-gray-200 rounded-lg">
                            <div class="flex items-center gap-2 p-3 border-b border-gray-200 bg-gray-50 flex-wrap">
                                <button onclick="showResourcePanel()" class="px-3 py-1.5 bg-purple-600 text-white rounded-lg text-xs flex items-center gap-1 hover:bg-purple-700">
                                    <i class="fas fa-plus"></i> 插入资源
                                </button>
                            </div>
                            <textarea id="chapterContent" class="w-full h-96 p-4 border-none focus:outline-none resize-none text-sm text-gray-700" placeholder="请先选择章节，或使用工具栏中的工具辅助编写..." oninput="updateChapterContent()"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 右侧AI对话助手（竖着放） -->
                <div class="w-80 flex-shrink-0">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden h-full flex flex-col">
                        <div class="flex items-center justify-between p-3 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-blue-50">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-purple-600 text-white flex items-center justify-center text-xs">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <h3 class="text-sm font-semibold text-gray-800">AI 内容助手</h3>
                            </div>
                            <button class="text-xs text-gray-500 hover:text-gray-700" id="chatToggleBtn" onclick="toggleChatPanel()">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                        <div id="chatContent" class="flex flex-col flex-1 min-h-0">
                            <div id="chatMessages" class="flex-1 overflow-y-auto p-3 space-y-3 text-xs">
                                <div class="flex gap-2">
                                    <div class="w-5 h-5 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center flex-shrink-0 text-[10px]">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="bg-gray-50 rounded-lg rounded-tl-none p-2 text-gray-700">
                                            <p>我可以帮您：修改内容、调整语气、补充细节、优化表达等。直接告诉我您的需求即可！</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-t border-gray-200 p-3 flex-shrink-0">
                                <div class="flex flex-col gap-2">
                                    <div class="relative">
                                        <textarea 
                                            id="chatInput" 
                                            placeholder="例如：把这段改得更专业一些..." 
                                            class="w-full px-2 py-1.5 pr-8 border border-gray-300 rounded-lg text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none"
                                            rows="3"
                                            onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendChatMessage(); }"
                                        ></textarea>
                                        <button onclick="showChapterSelector()" class="absolute right-2 bottom-2 text-gray-400 hover:text-purple-600 text-xs" title="选择章节">
                                            <i class="fas fa-at"></i>
                                        </button>
                                    </div>
                                    <button onclick="sendChatMessage()" class="w-full px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-xs flex items-center justify-center gap-1">
                                        <i class="fas fa-paper-plane text-[10px]"></i>
                                        <span>发送</span>
                                    </button>
                                    <p class="text-[10px] text-gray-400 text-center">Enter 发送，Shift+Enter 换行，@ 选择章节</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 工具面板 -->
    <div id="tool-image-lib" class="tool-panel hidden bg-white rounded-xl shadow-lg border border-gray-200 p-4 w-96 max-h-[500px] flex flex-col">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-800">图片素材库</h3>
            <button onclick="closeToolPanel('image-lib')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="mb-3">
            <div class="relative">
                <input type="text" id="imageSearch" placeholder="搜索图片..." class="w-full px-3 py-2 pl-9 border border-gray-300 rounded-lg text-sm" oninput="searchImages(this.value)">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto">
            <div id="imageGrid" class="grid grid-cols-2 gap-2">
                <div class="aspect-square bg-gradient-to-br from-blue-100 to-blue-200 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-2 hover:border-blue-500 border-2 border-transparent group" onclick="insertImage('架构图1.jpg', '系统架构图')">
                    <i class="fas fa-sitemap text-2xl text-blue-600 mb-2"></i>
                    <span class="text-xs text-blue-700 group-hover:font-semibold">架构图</span>
                </div>
                <div class="aspect-square bg-gradient-to-br from-green-100 to-green-200 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-2 hover:border-blue-500 border-2 border-transparent group" onclick="insertImage('流程图1.jpg', '业务流程图')">
                    <i class="fas fa-project-diagram text-2xl text-green-600 mb-2"></i>
                    <span class="text-xs text-green-700 group-hover:font-semibold">流程图</span>
                </div>
                <div class="aspect-square bg-gradient-to-br from-purple-100 to-purple-200 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-2 hover:border-blue-500 border-2 border-transparent group" onclick="insertImage('数据图1.jpg', '数据可视化')">
                    <i class="fas fa-chart-bar text-2xl text-purple-600 mb-2"></i>
                    <span class="text-xs text-purple-700 group-hover:font-semibold">数据图</span>
                </div>
                <div class="aspect-square bg-gradient-to-br from-orange-100 to-orange-200 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-2 hover:border-blue-500 border-2 border-transparent group" onclick="insertImage('界面图1.jpg', '系统界面')">
                    <i class="fas fa-desktop text-2xl text-orange-600 mb-2"></i>
                    <span class="text-xs text-orange-700 group-hover:font-semibold">界面图</span>
                </div>
            </div>
        </div>
        <button onclick="uploadImage()" class="w-full mt-3 px-3 py-2 text-xs text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-50">
            <i class="fas fa-upload mr-1"></i> 上传图片
        </button>
    </div>

    <div id="tool-company-lib" class="tool-panel hidden bg-white rounded-xl shadow-lg border border-gray-200 p-4 w-96 max-h-[500px] flex flex-col">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-800">企业素材档案库</h3>
            <button onclick="closeToolPanel('company-lib')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="mb-3">
            <div class="relative">
                <input type="text" id="companySearch" placeholder="搜索素材..." class="w-full px-3 py-2 pl-9 border border-gray-300 rounded-lg text-sm" oninput="searchCompanyMaterials(this.value)">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
            </div>
        </div>
        <div class="flex gap-2 mb-3 text-xs">
            <button onclick="filterCompanyMaterials('all')" class="px-3 py-1 bg-blue-600 text-white rounded-full">全部</button>
            <button onclick="filterCompanyMaterials('certificate')" class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200">资质</button>
            <button onclick="filterCompanyMaterials('case')" class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200">案例</button>
            <button onclick="filterCompanyMaterials('team')" class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200">团队</button>
        </div>
        <div id="companyMaterialsList" class="flex-1 overflow-y-auto space-y-2">
            <div class="p-3 border border-gray-100 rounded-lg cursor-pointer hover:border-blue-500 transition" data-type="certificate" onclick="insertCompanyMaterial('企业资质证书', '企业库 · 证件中心')">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-certificate text-blue-600"></i>
                        <p class="font-medium text-sm text-gray-800">企业资质证书</p>
                    </div>
                    <span class="text-xs text-green-600">已引用</span>
                </div>
                <p class="text-xs text-gray-500">来源：企业库 · 证件中心</p>
            </div>
            <div class="p-3 border border-gray-100 rounded-lg cursor-pointer hover:border-blue-500 transition" data-type="case" onclick="insertCompanyMaterial('智慧城市案例', '素材库 · 案例库')">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-folder-open text-green-600"></i>
                        <p class="font-medium text-sm text-gray-800">智慧城市案例</p>
                    </div>
                    <span class="text-xs text-gray-400">未引用</span>
                </div>
                <p class="text-xs text-gray-500">来源：素材库 · 案例库</p>
            </div>
            <div class="p-3 border border-gray-100 rounded-lg cursor-pointer hover:border-blue-500 transition" data-type="team" onclick="insertCompanyMaterial('专家团队简历', '企业库 · 人员档案')">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-users text-purple-600"></i>
                        <p class="font-medium text-sm text-gray-800">专家团队简历</p>
                    </div>
                    <span class="text-xs text-gray-400">未引用</span>
                </div>
                <p class="text-xs text-gray-500">来源：企业库 · 人员档案</p>
            </div>
            <div class="p-3 border border-gray-100 rounded-lg cursor-pointer hover:border-blue-500 transition" data-type="certificate" onclick="insertCompanyMaterial('ISO认证证书', '企业库 · 证件中心')">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-award text-yellow-600"></i>
                        <p class="font-medium text-sm text-gray-800">ISO认证证书</p>
                    </div>
                    <span class="text-xs text-gray-400">未引用</span>
                </div>
                <p class="text-xs text-gray-500">来源：企业库 · 证件中心</p>
            </div>
        </div>
    </div>

    <div id="tool-format" class="tool-panel hidden bg-white rounded-xl shadow-lg border border-gray-200 p-4 w-96">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-800">格式工具</h3>
            <button onclick="closeToolPanel('format')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-3 text-xs">
            <div class="p-3 border border-gray-100 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-font text-blue-600"></i>
                        <span class="font-medium">字体字号</span>
                    </div>
                    <span class="text-yellow-600"><i class="fas fa-exclamation-triangle"></i> 需修复</span>
                </div>
                <p class="text-gray-500 mb-2">正文应为三号仿宋，当前部分章节为默认字体</p>
                <button onclick="applyFormat('font')" class="w-full px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="fas fa-magic mr-1"></i> 一键修复
                </button>
            </div>
            <div class="p-3 border border-green-100 bg-green-50 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-arrows-alt-v text-green-600"></i>
                        <span class="font-medium">段落/行距</span>
                    </div>
                    <span class="text-green-600"><i class="fas fa-check"></i> 正常</span>
                </div>
                <p class="text-gray-500">已按 28pt 行距、段前后 0pt 设置</p>
            </div>
            <div class="p-3 border border-gray-100 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-heading text-blue-600"></i>
                        <span class="font-medium">页眉页脚</span>
                    </div>
                    <span class="text-gray-400">未设置</span>
                </div>
                <p class="text-gray-500 mb-2">明标需展示企业名称，暗标需留空</p>
                <button onclick="applyFormat('header')" class="w-full px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="fas fa-magic mr-1"></i> 套用模板
                </button>
            </div>
        </div>
    </div>

    <div id="tool-ai-image" class="tool-panel hidden bg-white rounded-xl shadow-lg border border-gray-200 p-4 w-96">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-800">AI生图</h3>
            <button onclick="closeToolPanel('ai-image')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-3">
            <div>
                <label class="block text-xs text-gray-600 mb-1">图片描述</label>
                <textarea id="imagePrompt" placeholder="例如：系统架构图，包含前端、后端、数据库三层结构..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-none" rows="3"></textarea>
            </div>
            <div>
                <label class="block text-xs text-gray-600 mb-1">图片风格</label>
                <select id="imageStyle" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    <option>商务风格</option>
                    <option>技术图表</option>
                    <option>流程图</option>
                    <option>数据可视化</option>
                </select>
            </div>
            <button onclick="generateImage()" id="generateImageBtn" class="w-full px-3 py-2 bg-orange-600 text-white rounded-lg text-sm hover:bg-orange-700">
                <i class="fas fa-magic mr-2"></i> 生成图片
            </button>
            <div id="imagePreview" class="hidden mt-3 p-3 border border-gray-200 rounded-lg">
                <p class="text-xs text-gray-600 mb-2">生成结果：</p>
                <div class="aspect-video bg-gray-100 rounded flex items-center justify-center">
                    <i class="fas fa-image text-3xl text-gray-400"></i>
                </div>
                <div class="flex gap-2 mt-2">
                    <button onclick="insertGeneratedImage()" class="flex-1 px-3 py-1.5 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                        <i class="fas fa-plus mr-1"></i> 插入
                    </button>
                    <button onclick="regenerateImage()" class="flex-1 px-3 py-1.5 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200">
                        <i class="fas fa-redo mr-1"></i> 重新生成
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 导出模态框 -->
    <div id="exportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">导出标书</h3>
                <button onclick="closeExportModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">选择导出格式</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="export-format-option relative flex flex-col items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition" data-format="word">
                            <input type="radio" name="exportFormat" value="word" class="sr-only" checked>
                            <i class="fas fa-file-word text-4xl text-blue-600 mb-2"></i>
                            <span class="text-sm font-medium text-gray-700">Word 文档</span>
                            <span class="text-xs text-gray-500 mt-1">.docx</span>
                            <i class="fas fa-check-circle absolute top-2 right-2 text-blue-600 hidden"></i>
                        </label>
                        <label class="export-format-option relative flex flex-col items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition" data-format="pdf">
                            <input type="radio" name="exportFormat" value="pdf" class="sr-only">
                            <i class="fas fa-file-pdf text-4xl text-red-600 mb-2"></i>
                            <span class="text-sm font-medium text-gray-700">PDF 文档</span>
                            <span class="text-xs text-gray-500 mt-1">.pdf</span>
                            <i class="fas fa-check-circle absolute top-2 right-2 text-blue-600 hidden"></i>
                        </label>
                    </div>
                </div>
                <div class="p-3 bg-blue-50 border border-blue-100 rounded-lg">
                    <div class="flex items-start gap-2">
                        <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                        <div class="text-xs text-gray-700">
                            <p class="font-medium text-blue-800 mb-1">导出说明</p>
                            <p id="exportDescription">Word格式支持后续编辑，保留所有格式和样式。</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex gap-3">
                <button onclick="closeExportModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">取消</button>
                <button onclick="executeExport()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    <i class="fas fa-download mr-2"></i> 开始导出
                </button>
            </div>
        </div>
    </div>

    <!-- 章节预览模态框 -->
    <div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden shadow-2xl">
            <div class="px-6 py-4 border-b flex items-center justify-between">
                <div>
                    <p class="text-[11px] text-gray-400 uppercase tracking-wide">章节预览</p>
                    <h3 class="text-lg font-semibold text-gray-900" id="previewTitle">章节标题</h3>
                </div>
                <button class="text-gray-400 hover:text-gray-600" onclick="closePreviewModal()"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="flex-1 overflow-auto bg-gray-100 p-6">
                <div id="previewContent" class="mx-auto bg-white rounded-2xl border border-gray-200 shadow p-10 w-[740px] min-h-[880px] text-gray-800 leading-relaxed">
                </div>
            </div>
            <div class="px-6 py-4 border-t flex items-center justify-between text-sm">
                <div class="text-gray-500">
                    <p>预览为Word格式排版示意，导出时将自动应用页眉页脚、字体字号等规范。</p>
                </div>
                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg" onclick="closePreviewModal()">关闭预览</button>
            </div>
        </div>
    </div>

    <!-- AI操作模态框 -->
    <div id="aiModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold" id="aiModalTitle">AI生成内容</h3>
                <button onclick="closeAIModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">内容描述</label>
                    <textarea id="aiPromptInput" placeholder="描述您要生成的内容..." class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm resize-none" rows="4"></textarea>
                    <p class="text-xs text-gray-500 mt-1">详细描述有助于AI生成更精准的内容</p>
                </div>
                <div class="p-3 bg-blue-50 border border-blue-100 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-info-circle text-blue-600"></i>
                        <span class="text-xs font-medium text-blue-800">已引用知识库</span>
                    </div>
                    <div id="aiKnowledgeList" class="flex flex-wrap gap-2">
                        <span class="px-2 py-1 bg-white border border-blue-200 rounded text-xs text-blue-700">
                            智慧城市项目案例库
                        </span>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex gap-3">
                <button onclick="closeAIModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">取消</button>
                <button id="aiGenerateBtn" onclick="executeAIAction()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    <i class="fas fa-magic mr-2"></i> 生成内容
                </button>
            </div>
            <input type="hidden" id="aiModalMode" value="">
        </div>
    </div>

    <div id="knowledgeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">选择企业知识库及文件</h3>
                <button onclick="closeKnowledgeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <!-- 搜索框 -->
            <div class="mb-4">
                <div class="relative">
                    <input type="text" id="knowledgeSearchInput" placeholder="搜索知识库或文件名..." 
                           class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           oninput="searchKnowledgeFiles(this.value)">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <button id="clearSearchBtn" onclick="clearKnowledgeSearch()" class="hidden absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="searchResultCount" class="hidden text-xs text-gray-500 mt-2">
                    <span id="searchCountText">找到 <span id="matchCount">0</span> 个匹配项</span>
                </div>
            </div>
            <div id="knowledgeListContainer" class="flex-1 overflow-y-auto space-y-3 mb-4">
                <!-- 知识库1 -->
                <div class="knowledge-item border border-gray-200 rounded-lg overflow-hidden" data-knowledge-name="智慧城市项目案例库">
                    <div class="p-3 bg-gray-50 flex items-center justify-between cursor-pointer hover:bg-gray-100" onclick="toggleKnowledgeFiles('knowledge-1')">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform" id="icon-knowledge-1"></i>
                            <p class="font-medium text-sm">智慧城市项目案例库</p>
                            <span class="text-xs text-gray-500">(15个文件)</span>
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer" onclick="event.stopPropagation()">
                            <input type="checkbox" class="knowledge-checkbox" data-knowledge="智慧城市项目案例库" onchange="toggleAllFiles('knowledge-1', this.checked)">
                            <span class="text-xs text-gray-600">全选</span>
                        </label>
                    </div>
                    <div id="knowledge-1" class="hidden border-t border-gray-200 bg-white">
                        <div class="p-2 space-y-1">
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="智慧城市项目案例库" data-file="智慧城市数字底座项目案例.docx" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-word text-blue-600 text-xs"></i>
                                <span class="text-xs text-gray-700">智慧城市数字底座项目案例.docx</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="智慧城市项目案例库" data-file="城市大脑平台建设方案.pdf" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-pdf text-red-600 text-xs"></i>
                                <span class="text-xs text-gray-700">城市大脑平台建设方案.pdf</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="智慧城市项目案例库" data-file="数据治理平台技术方案.docx" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-word text-blue-600 text-xs"></i>
                                <span class="text-xs text-gray-700">数据治理平台技术方案.docx</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="智慧城市项目案例库" data-file="物联网感知层架构设计.docx" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-word text-blue-600 text-xs"></i>
                                <span class="text-xs text-gray-700">物联网感知层架构设计.docx</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="智慧城市项目案例库" data-file="智慧交通系统实施方案.pdf" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-pdf text-red-600 text-xs"></i>
                                <span class="text-xs text-gray-700">智慧交通系统实施方案.pdf</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- 知识库2 -->
                <div class="knowledge-item border border-gray-200 rounded-lg overflow-hidden" data-knowledge-name="技术标准知识库">
                    <div class="p-3 bg-gray-50 flex items-center justify-between cursor-pointer hover:bg-gray-100" onclick="toggleKnowledgeFiles('knowledge-2')">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform" id="icon-knowledge-2"></i>
                            <p class="font-medium text-sm">技术标准知识库</p>
                            <span class="text-xs text-gray-500">(12个文件)</span>
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer" onclick="event.stopPropagation()">
                            <input type="checkbox" class="knowledge-checkbox" data-knowledge="技术标准知识库" onchange="toggleAllFiles('knowledge-2', this.checked)">
                            <span class="text-xs text-gray-600">全选</span>
                        </label>
                    </div>
                    <div id="knowledge-2" class="hidden border-t border-gray-200 bg-white">
                        <div class="p-2 space-y-1">
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="技术标准知识库" data-file="GB/T 22239-2019 信息安全技术网络安全等级保护基本要求.pdf" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-pdf text-red-600 text-xs"></i>
                                <span class="text-xs text-gray-700">GB/T 22239-2019 信息安全技术网络安全等级保护基本要求.pdf</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="技术标准知识库" data-file="微服务架构设计规范.docx" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-word text-blue-600 text-xs"></i>
                                <span class="text-xs text-gray-700">微服务架构设计规范.docx</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="技术标准知识库" data-file="数据安全管理办法.docx" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-word text-blue-600 text-xs"></i>
                                <span class="text-xs text-gray-700">数据安全管理办法.docx</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="技术标准知识库" data-file="云计算平台技术规范.pdf" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-pdf text-red-600 text-xs"></i>
                                <span class="text-xs text-gray-700">云计算平台技术规范.pdf</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- 知识库3 -->
                <div class="knowledge-item border border-gray-200 rounded-lg overflow-hidden" data-knowledge-name="企业资质库">
                    <div class="p-3 bg-gray-50 flex items-center justify-between cursor-pointer hover:bg-gray-100" onclick="toggleKnowledgeFiles('knowledge-3')">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform" id="icon-knowledge-3"></i>
                            <p class="font-medium text-sm">企业资质库</p>
                            <span class="text-xs text-gray-500">(8个文件)</span>
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer" onclick="event.stopPropagation()">
                            <input type="checkbox" class="knowledge-checkbox" data-knowledge="企业资质库" onchange="toggleAllFiles('knowledge-3', this.checked)">
                            <span class="text-xs text-gray-600">全选</span>
                        </label>
                    </div>
                    <div id="knowledge-3" class="hidden border-t border-gray-200 bg-white">
                        <div class="p-2 space-y-1">
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="企业资质库" data-file="ISO 9001质量管理体系认证证书.pdf" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-pdf text-red-600 text-xs"></i>
                                <span class="text-xs text-gray-700">ISO 9001质量管理体系认证证书.pdf</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="企业资质库" data-file="信息系统集成资质证书.pdf" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-pdf text-red-600 text-xs"></i>
                                <span class="text-xs text-gray-700">信息系统集成资质证书.pdf</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="企业资质库" data-file="软件著作权登记证书.pdf" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-pdf text-red-600 text-xs"></i>
                                <span class="text-xs text-gray-700">软件著作权登记证书.pdf</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" class="file-checkbox" data-knowledge="企业资质库" data-file="高新技术企业证书.pdf" onchange="updateKnowledgeSelection()">
                                <i class="fas fa-file-pdf text-red-600 text-xs"></i>
                                <span class="text-xs text-gray-700">高新技术企业证书.pdf</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-200 pt-4 flex gap-3">
                <button onclick="closeKnowledgeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">取消</button>
                <button onclick="confirmKnowledgeSelection()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="fas fa-check mr-2"></i> 确认选择
                </button>
            </div>
        </div>
    </div>

    <!-- 章节选择器模态框 -->
    <div id="chapterSelectorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 max-w-md w-full max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-800">选择章节</h3>
                <button onclick="closeChapterSelector()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-3">
                <input type="text" id="chapterSearchInput" placeholder="搜索章节..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-xs focus:outline-none focus:ring-1 focus:ring-blue-500"
                       oninput="searchChapters(this.value)">
            </div>
            <div id="chapterSelectorList" class="flex-1 overflow-y-auto space-y-1 text-xs">
                <!-- 章节列表将动态生成 -->
            </div>
        </div>
    </div>

    <!-- 插入资源面板 -->
    <div id="resourcePanel" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">插入资源</h3>
                <button onclick="closeResourcePanel()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- 搜索框 -->
            <div class="mb-4">
                <div class="relative">
                    <input type="text" id="resourceSearchInput" placeholder="搜索资源名称、描述、标签..." 
                           class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                           oninput="searchResourcesInPanel()">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
            
            <!-- 页签 -->
            <div class="flex gap-2 mb-4 text-sm border-b border-gray-200 overflow-x-auto">
                <button onclick="switchResourceTab('image')" class="resource-tab-btn px-4 py-2 bg-blue-600 text-white rounded-t-lg whitespace-nowrap" data-tab="image">
                    <i class="fas fa-images mr-2"></i>图片库
                </button>
                <button onclick="switchResourceTab('material')" class="resource-tab-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-t-lg hover:bg-gray-200 whitespace-nowrap" data-tab="material">
                    <i class="fas fa-folder-open mr-2"></i>企业素材库
                </button>
                <button onclick="switchResourceTab('case')" class="resource-tab-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-t-lg hover:bg-gray-200 whitespace-nowrap" data-tab="case">
                    <i class="fas fa-briefcase mr-2"></i>企业案例库
                </button>
                <button onclick="switchResourceTab('knowledge')" class="resource-tab-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-t-lg hover:bg-gray-200 whitespace-nowrap" data-tab="knowledge">
                    <i class="fas fa-book mr-2"></i>行业知识库
                </button>
                <button onclick="switchResourceTab('certificate')" class="resource-tab-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-t-lg hover:bg-gray-200 whitespace-nowrap" data-tab="certificate">
                    <i class="fas fa-certificate mr-2"></i>资质证件
                </button>
                <button onclick="switchResourceTab('template')" class="resource-tab-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-t-lg hover:bg-gray-200 whitespace-nowrap" data-tab="template">
                    <i class="fas fa-file-alt mr-2"></i>标书模板
                </button>
            </div>
            
            <!-- 资源内容区域 -->
            <div id="resourceContent" class="flex-1 overflow-y-auto">
                <!-- 资源内容将动态加载 -->
            </div>
        </div>
    </div>

    <script>
        // 存储键名
        const STORAGE_KEY = 'bidding_draft_data';
        const STORAGE_CATALOG_KEY = 'bidding_catalog_data';
        const STORAGE_SETTINGS_KEY = 'bidding_settings_data';
        
        // 章节数据存储
        window.chapterContents = {};
        window.chapterStates = {}; // { chapterId: { confirmed: boolean, confirmedAt: timestamp } }
        window.currentChapterId = null;
        let autoSaveTimer = null;
        let lastSaveTime = null;
        
        // 初始化页面
        window.addEventListener('load', function() {
            // 恢复保存的数据
            restoreSavedData();
            
            // 加载标书名称
            loadBidName();
            
            loadCatalogStructure();
            updateWritingStatus();
            updateConfirmButtonState();
            
            // 自动生成商务内容（基于标书设置中的配置）
            autoGenerateBusinessContent();
            
            // 如果恢复了当前章节，自动选中
            if (window.currentChapterId && window.catalogData) {
                const findChapter = (chapters, id) => {
                    for (const chapter of chapters) {
                        if (chapter.id === id) {
                            return { chapter, title: chapter.title };
                        }
                        if (chapter.children) {
                            for (const sub of chapter.children) {
                                if (sub.id === id) {
                                    return { chapter: sub, title: sub.title };
                                }
                            }
                        }
                    }
                    return null;
                };
                const found = findChapter(window.catalogData, window.currentChapterId);
                if (found) {
                    selectChapter(window.currentChapterId, found.title);
                }
            }
            
            // 启动自动保存（每30秒保存一次）
            startAutoSave();
            
            // 页面关闭前保存
            window.addEventListener('beforeunload', function() {
                saveToLocalStorage();
            });
            
            // 点击外部区域关闭工具面板
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.tool-panel') && !e.target.closest('button[onclick*="showToolPanel"]')) {
                    document.querySelectorAll('.tool-panel').forEach(panel => {
                        if (!panel.classList.contains('hidden')) {
                            panel.classList.add('hidden');
                        }
                    });
                }
            });
        });
        
        // 恢复保存的数据
        function restoreSavedData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.chapterContents) {
                        window.chapterContents = data.chapterContents;
                    }
                    if (data.chapterStates) {
                        window.chapterStates = data.chapterStates;
                    }
                    if (data.currentChapterId) {
                        window.currentChapterId = data.currentChapterId;
                    }
                    if (data.selectedKnowledgeFiles) {
                        window.selectedKnowledgeFiles = data.selectedKnowledgeFiles;
                    }
                    console.log('已恢复保存的标书内容');
                }
                
                // 恢复目录数据
                const savedCatalog = localStorage.getItem(STORAGE_CATALOG_KEY);
                if (savedCatalog) {
                    window.catalogData = JSON.parse(savedCatalog);
                    console.log('已恢复保存的目录结构');
                }
            } catch (e) {
                console.error('恢复数据失败:', e);
            }
        }

        // 加载标书名称
        function loadBidName() {
            try {
                const savedSettings = localStorage.getItem(STORAGE_SETTINGS_KEY);
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    if (settings.bookTitle) {
                        document.getElementById('bidName').textContent = settings.bookTitle;
                        return;
                    }
                }
                // 如果没有保存的设置，使用默认值
                document.getElementById('bidName').textContent = '城市运行数字底座建设项目';
            } catch (e) {
                console.error('加载标书名称失败:', e);
                document.getElementById('bidName').textContent = '城市运行数字底座建设项目';
            }
        }
        
        // 保存到本地存储
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    chapterContents: window.chapterContents,
                    chapterStates: window.chapterStates,
                    currentChapterId: window.currentChapterId,
                    selectedKnowledgeFiles: window.selectedKnowledgeFiles || {},
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                
                // 保存目录数据
                if (window.catalogData) {
                    localStorage.setItem(STORAGE_CATALOG_KEY, JSON.stringify(window.catalogData));
                }
                
                lastSaveTime = new Date();
                updateSaveStatus('saved');
                return true;
            } catch (e) {
                console.error('保存失败:', e);
                updateSaveStatus('error');
                return false;
            }
        }
        
        // 启动自动保存
        function startAutoSave() {
            // 每30秒自动保存一次
            autoSaveTimer = setInterval(function() {
                if (Object.keys(window.chapterContents).length > 0 || window.catalogData) {
                    saveToLocalStorage();
                }
            }, 30000);
        }
        
        // 手动保存
        function manualSave() {
            const success = saveToLocalStorage();
            if (success) {
                showToast('保存成功', 'success');
            } else {
                showToast('保存失败，请重试', 'error');
            }
        }
        
        // 更新保存状态显示
        function updateSaveStatus(status) {
            const statusEl = document.getElementById('saveStatus');
            if (!statusEl) return;
            
            if (status === 'saving') {
                statusEl.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500"></i><span>保存中...</span>';
                statusEl.classList.remove('hidden');
            } else if (status === 'saved') {
                const timeStr = lastSaveTime ? formatTime(lastSaveTime) : '刚刚';
                statusEl.innerHTML = `<i class="fas fa-check-circle text-green-500"></i><span>已保存 ${timeStr}</span>`;
                statusEl.classList.remove('hidden');
                // 3秒后淡出
                setTimeout(() => {
                    statusEl.style.opacity = '0.5';
                }, 3000);
            } else if (status === 'error') {
                statusEl.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i><span>保存失败</span>';
                statusEl.classList.remove('hidden');
            }
        }
        
        // 格式化时间
        function formatTime(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return '刚刚';
            if (diff < 3600) return `${Math.floor(diff / 60)}分钟前`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}小时前`;
            return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        function loadCatalogStructure() {
            // 优先使用恢复的目录数据，如果没有则从标书设置获取，最后使用默认
            if (!window.catalogData || window.catalogData.length === 0) {
                // 尝试从localStorage恢复
                try {
                    const savedCatalog = localStorage.getItem(STORAGE_CATALOG_KEY);
                    if (savedCatalog) {
                        window.catalogData = JSON.parse(savedCatalog);
                    }
                } catch (e) {
                    console.error('恢复目录数据失败:', e);
                }
            }
            
            if (!window.catalogData || window.catalogData.length === 0) {
                window.catalogData = [
                    { id: 1, title: '第一部分 投标函及投标函附录', children: [
                        { id: 11, title: '1.1 投标函' },
                        { id: 12, title: '1.2 投标函附录' }
                    ]},
                    { id: 2, title: '第二部分 法定代表人身份证明', children: [] },
                    { id: 3, title: '第三部分 技术方案', children: [
                        { id: 31, title: '3.1 项目理解' },
                        { id: 32, title: '3.2 技术架构' },
                        { id: 33, title: '3.3 实施方案' },
                        { id: 34, title: '3.4 质量保证措施' }
                    ]},
                    { id: 4, title: '第四部分 商务部分', children: [
                        { id: 41, title: '4.1 报价明细' },
                        { id: 42, title: '4.2 付款方式' },
                        { id: 43, title: '4.3 售后服务' }
                    ]},
                    { id: 5, title: '第五部分 资格证明文件', children: [
                        { id: 51, title: '5.1 企业资质' },
                        { id: 52, title: '5.2 业绩案例' },
                        { id: 53, title: '5.3 团队配置' }
                    ]}
                ];
            }
            
            renderChapterTree();
            // 初始化知识库列表显示
            renderKnowledgeList();
        }
        
        function renderChapterTree() {
            const container = document.getElementById('chapterTree');
            container.innerHTML = '';
            
            if (!window.catalogData || window.catalogData.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">暂无章节数据</p>';
                return;
            }
            
            const filter = document.getElementById('chapterFilter')?.value || 'all';
            
            window.catalogData.forEach((chapter, index) => {
                const chapterId = chapter.id;
                const status = getChapterStatus(chapterId);
                const hasChildren = chapter.children && chapter.children.length > 0;
                const isRequired = chapter.required || false; // 是否为实质项
                
                // 应用筛选
                if (filter === 'required' && !isRequired) return;
                if (filter === 'pending' && status !== 'pending') return;
                if (filter === 'writing' && status !== 'writing') return;
                if (filter === 'completed' && status !== 'completed') return;
                
                // 主章节
                const mainDiv = document.createElement('div');
                mainDiv.className = 'mb-2';
                mainDiv.innerHTML = `
                    <button onclick="selectChapter(${chapterId}, '${chapter.title}')" 
                            class="w-full text-left px-3 py-2 rounded-lg flex items-center justify-between transition ${window.currentChapterId === chapterId ? 'bg-purple-50 text-purple-600 font-semibold border border-purple-200' : 'hover:bg-gray-50 border border-transparent'}"
                            data-chapter-id="${chapterId}" data-required="${isRequired}">
                        <span class="flex items-center gap-2">
                            ${hasChildren ? '<i class="fas fa-chevron-down text-xs text-gray-400"></i>' : '<i class="fas fa-file-alt text-xs text-gray-400"></i>'}
                            <span class="text-sm">${chapter.title}</span>
                            ${isRequired ? '<span class="px-1.5 py-0.5 bg-red-100 text-red-700 rounded text-[10px]">实质项</span>' : ''}
                        </span>
                        <span class="text-xs ${getStatusColor(status)}">${getStatusText(status)}</span>
                    </button>
                `;
                container.appendChild(mainDiv);
                
                // 子章节
                if (hasChildren) {
                    const subContainer = document.createElement('div');
                    subContainer.className = 'ml-6 mb-2 space-y-1';
                    chapter.children.forEach((sub) => {
                        const subId = sub.id;
                        const subStatus = getChapterStatus(subId);
                        const subRequired = sub.required || false;
                        
                        // 应用筛选
                        if (filter === 'required' && !subRequired) return;
                        if (filter === 'pending' && subStatus !== 'pending') return;
                        if (filter === 'writing' && subStatus !== 'writing') return;
                        if (filter === 'completed' && subStatus !== 'completed') return;
                        
                        const subDiv = document.createElement('div');
                        subDiv.innerHTML = `
                            <button onclick="selectChapter(${subId}, '${sub.title}')" 
                                    class="w-full text-left px-2 py-1.5 rounded text-xs flex items-center justify-between transition ${window.currentChapterId === subId ? 'bg-purple-50 text-purple-600 font-semibold border border-purple-200' : 'hover:bg-gray-50 border border-transparent'}"
                                    data-chapter-id="${subId}" data-required="${subRequired}">
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-file text-[10px] text-gray-400"></i>
                                    <span>${sub.title}</span>
                                    ${subRequired ? '<span class="px-1 py-0.5 bg-red-100 text-red-700 rounded text-[9px]">实质项</span>' : ''}
                                </span>
                                <span class="text-[10px] ${getStatusColor(subStatus)}">${getStatusText(subStatus)}</span>
                            </button>
                        `;
                        subContainer.appendChild(subDiv);
                    });
                    container.appendChild(subContainer);
                }
            });
        }
        
        // 章节筛选
        function filterChapters() {
            renderChapterTree();
        }
        
        function getChapterStatus(chapterId) {
            const state = window.chapterStates[chapterId];
            if (state && state.confirmed) return 'completed';
            const content = window.chapterContents[chapterId];
            if (!content || content.trim() === '') return 'pending';
            return 'writing';
        }
        
        function getStatusText(status) {
            const statusMap = {
                'pending': '未开始',
                'writing': '编写中',
                'completed': '已完成'
            };
            return statusMap[status] || '未开始';
        }
        
        function getStatusColor(status) {
            const colorMap = {
                'pending': 'text-gray-400',
                'writing': 'text-yellow-500',
                'completed': 'text-green-500'
            };
            return colorMap[status] || 'text-gray-400';
        }
        
        function selectChapter(chapterId, chapterTitle) {
            window.currentChapterId = chapterId;
            document.getElementById('currentChapter').textContent = chapterTitle;
            document.getElementById('chapterContent').value = window.chapterContents[chapterId] || '';
            
            // 检查是否为实质项
            const chapterBtn = document.querySelector(`[data-chapter-id="${chapterId}"]`);
            const isRequired = chapterBtn?.dataset.required === 'true';
            const riskBadge = document.getElementById('chapterRiskBadge');
            if (isRequired) {
                riskBadge.classList.remove('hidden');
                riskBadge.textContent = '实质项';
            } else {
                riskBadge.classList.add('hidden');
            }
            
            renderChapterTree();
            updateConfirmButtonState();
            updateComplianceStatus();
        }
        
        function updateChapterContent() {
            if (window.currentChapterId) {
                window.chapterContents[window.currentChapterId] = document.getElementById('chapterContent').value;
                if (window.chapterStates[window.currentChapterId] && window.chapterStates[window.currentChapterId].confirmed) {
                    window.chapterStates[window.currentChapterId].confirmed = false;
                }
                updateWritingStatus();
                renderChapterTree();
                updateConfirmButtonState();
                
                // 内容变化时更新保存状态
                updateSaveStatus('saving');
                // 防抖保存（2秒后保存）
                clearTimeout(window.saveDebounceTimer);
                window.saveDebounceTimer = setTimeout(function() {
                    saveToLocalStorage();
                }, 2000);
            }
        }

        function updateConfirmButtonState() {
            const btn = document.getElementById('confirmChapterBtn');
            if (!btn) return;
            if (!window.currentChapterId) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> 标记已完成';
                return;
            }
            const state = window.chapterStates[window.currentChapterId];
            if (state && state.confirmed) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> 已确认完成';
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> 标记已完成';
            }
        }

        function confirmChapterCompletion() {
            if (!window.currentChapterId) {
                showToast('请先选择章节', 'warning');
                return;
            }
            const content = window.chapterContents[window.currentChapterId];
            if (!content || content.trim().length < 50) {
                showToast('内容太少，无法标记为完成', 'warning');
                return;
            }
            if (!window.chapterStates[window.currentChapterId]) {
                window.chapterStates[window.currentChapterId] = {};
            }
            window.chapterStates[window.currentChapterId].confirmed = true;
            window.chapterStates[window.currentChapterId].confirmedAt = Date.now();
            showToast('章节已标记为完成', 'success');
            updateConfirmButtonState();
            updateWritingStatus();
            renderChapterTree();
        }

        function previewCurrentChapter() {
            if (!window.currentChapterId) {
                showToast('请先选择章节', 'warning');
                return;
            }
            const content = window.chapterContents[window.currentChapterId];
            if (!content || content.trim() === '') {
                showToast('当前章节暂无内容', 'warning');
                return;
            }
            const previewTitle = document.getElementById('previewTitle');
            const previewContent = document.getElementById('previewContent');
            previewTitle.textContent = document.getElementById('currentChapter').textContent;

            const paragraphs = content.split(/\n+/).filter(line => line.trim() !== '');
            previewContent.innerHTML = paragraphs.map((paragraph, index) => {
                if (/^第[一二三四五六七八九十]+/.test(paragraph.trim())) {
                    return `<p class="text-xl font-bold text-gray-900 mb-4">${paragraph.trim()}</p>`;
                }
                if (/^\d+(\.\d+)*\s/.test(paragraph.trim())) {
                    return `<p class="text-base font-semibold text-gray-800 mb-3">${paragraph.trim()}</p>`;
                }
                return `<p class="text-base text-gray-700 leading-relaxed mb-3">${paragraph.trim()}</p>`;
            }).join('');

            document.getElementById('previewModal').classList.remove('hidden');
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.add('hidden');
        }
        
        function updateWritingStatus() {
            if (!window.catalogData) return;
            
            let total = 0;
            let completed = 0;
            let writing = 0;
            let pending = 0;
            
            window.catalogData.forEach(chapter => {
                total++;
                const mainStatus = getChapterStatus(chapter.id);
                if (mainStatus === 'completed') completed++;
                else if (mainStatus === 'writing') writing++;
                else pending++;
                
                if (chapter.children) {
                    chapter.children.forEach(sub => {
                        total++;
                        const subStatus = getChapterStatus(sub.id);
                        if (subStatus === 'completed') completed++;
                        else if (subStatus === 'writing') writing++;
                        else pending++;
                    });
                }
            });
            
            document.getElementById('totalChapters').textContent = total;
            document.getElementById('completedChapters').textContent = completed;
            document.getElementById('writingChapters').textContent = writing;
            document.getElementById('pendingChapters').textContent = pending;
            
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('progressPercent').textContent = progress + '%';
            document.getElementById('progressBar').style.width = progress + '%';
            
            // 更新最后更新时间
            const updateTimeEl = document.getElementById('statusUpdateTime');
            if (updateTimeEl) {
                updateTimeEl.textContent = '刚刚';
            }
        }

        // 编写情况收起/展开功能
        let writingStatusCollapsed = false;
        function toggleWritingStatus() {
            const content = document.getElementById('writingStatusContent');
            const toggleBtn = document.getElementById('statusToggleBtn');
            const icon = toggleBtn.querySelector('i');
            
            writingStatusCollapsed = !writingStatusCollapsed;
            
            if (writingStatusCollapsed) {
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }
        
        function showToolPanel(toolName) {
            console.log('showToolPanel called with:', toolName);
            
            // 关闭所有工具面板和模态框
            document.querySelectorAll('.tool-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.add('hidden');
            });
            
            // 如果是AI工具，显示模态框
            if (toolName === 'ai-write') {
                insertAIContent();
                return;
            } else if (toolName === 'ai-rewrite') {
                rewriteContent();
                return;
            } else if (toolName === 'ai-expand') {
                expandContent();
                return;
            } else if (toolName === 'ai-polish') {
                polishContent();
                return;
            }
            
            // 显示对应的工具面板
            const panel = document.getElementById('tool-' + toolName);
            if (!panel) {
                console.error('Panel not found:', 'tool-' + toolName);
                showToast('工具面板未找到', 'error');
                return;
            }
            
            console.log('Panel found:', panel);
            
            // 找到触发按钮
            const buttons = document.querySelectorAll('button[onclick*="showToolPanel"]');
            let targetButton = null;
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick') || '';
                if (onclick.includes(`'${toolName}'`) || onclick.includes(`"${toolName}"`)) {
                    targetButton = btn;
                }
            });
            
            console.log('Target button:', targetButton);
            
            if (targetButton) {
                const rect = targetButton.getBoundingClientRect();
                console.log('Button rect:', rect);
                
                // 使用fixed定位，相对于视口（在iframe中就是iframe的视口）
                panel.style.position = 'fixed';
                panel.style.top = (rect.bottom + 8) + 'px';
                // 确保面板不会超出右边界
                const panelWidth = 384; // w-96 = 384px
                const leftPos = Math.max(20, Math.min(rect.left, window.innerWidth - panelWidth - 20));
                panel.style.left = leftPos + 'px';
                panel.style.zIndex = '1000';
                panel.classList.remove('hidden');
                // 确保面板可见
                panel.style.visibility = 'visible';
                panel.style.opacity = '1';
                console.log('Panel shown at:', panel.style.top, panel.style.left, 'Panel visible:', !panel.classList.contains('hidden'));
            } else {
                console.log('Button not found, using fallback position');
                // 如果找不到按钮，使用默认位置
                const editorArea = document.querySelector('.border.border-gray-200.rounded-lg');
                if (editorArea) {
                    const rect = editorArea.getBoundingClientRect();
                    panel.style.position = 'fixed';
                    panel.style.top = (rect.top + 60) + 'px';
                    panel.style.left = (rect.left + 20) + 'px';
                    panel.style.zIndex = '1000';
                    panel.classList.remove('hidden');
                    panel.style.visibility = 'visible';
                    panel.style.opacity = '1';
                } else {
                    // 最后的后备方案
                    panel.style.position = 'fixed';
                    panel.style.top = '100px';
                    panel.style.left = '50%';
                    panel.style.transform = 'translateX(-50%)';
                    panel.style.zIndex = '1000';
                    panel.classList.remove('hidden');
                    panel.style.visibility = 'visible';
                    panel.style.opacity = '1';
                }
            }
            
            // 添加点击外部关闭功能
            setTimeout(() => {
                const closeOnOutsideClick = (e) => {
                    if (!panel.contains(e.target) && !e.target.closest('button[onclick*="showToolPanel"]')) {
                        panel.classList.add('hidden');
                        document.removeEventListener('click', closeOnOutsideClick);
                    }
                };
                document.addEventListener('click', closeOnOutsideClick);
            }, 100);
        }
        
        function closeToolPanel(toolName) {
            const panel = document.getElementById('tool-' + toolName);
            if (panel) {
                panel.classList.add('hidden');
            }
        }
        
        function insertImage(imageUrl, imageName) {
            const editor = document.getElementById('chapterContent');
            if (!window.currentChapterId) {
                showToast('请先选择章节', 'warning');
                return;
            }
            const cursorPos = editor.selectionStart;
            const textBefore = editor.value.substring(0, cursorPos);
            const textAfter = editor.value.substring(cursorPos);
            editor.value = textBefore + `\n[图片: ${imageName || imageUrl}]\n` + textAfter;
            editor.focus();
            editor.setSelectionRange(cursorPos + imageName.length + 10, cursorPos + imageName.length + 10);
            updateChapterContent();
            closeToolPanel('image-lib');
            showToast('图片已插入', 'success');
        }
        
        function searchImages(keyword) {
            // 模拟搜索功能
            const images = document.querySelectorAll('#imageGrid > div');
            images.forEach(img => {
                const text = img.textContent.toLowerCase();
                if (text.includes(keyword.toLowerCase()) || keyword === '') {
                    img.style.display = 'block';
                } else {
                    img.style.display = 'none';
                }
            });
        }
        
        function uploadImage() {
            showToast('上传功能开发中', 'info');
        }
        
        function insertCompanyMaterial(materialName, source) {
            const editor = document.getElementById('chapterContent');
            if (!window.currentChapterId) {
                showToast('请先选择章节', 'warning');
                return;
            }
            const cursorPos = editor.selectionStart;
            const textBefore = editor.value.substring(0, cursorPos);
            const textAfter = editor.value.substring(cursorPos);
            editor.value = textBefore + `\n[引用${materialName} - ${source}]\n` + textAfter;
            editor.focus();
            editor.setSelectionRange(cursorPos + materialName.length + source.length + 8, cursorPos + materialName.length + source.length + 8);
            updateChapterContent();
            closeToolPanel('company-lib');
            showToast(`${materialName}已插入`, 'success');
        }
        
        function searchCompanyMaterials(keyword) {
            const materials = document.querySelectorAll('#companyMaterialsList > div');
            materials.forEach(material => {
                const text = material.textContent.toLowerCase();
                if (text.includes(keyword.toLowerCase()) || keyword === '') {
                    material.style.display = 'block';
                } else {
                    material.style.display = 'none';
                }
            });
        }
        
        function filterCompanyMaterials(type) {
            const buttons = document.querySelectorAll('#tool-company-lib .rounded-full');
            buttons.forEach(btn => {
                if (btn.textContent.includes('全部') && type === 'all') {
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else if (btn.textContent.includes('资质') && type === 'certificate') {
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else if (btn.textContent.includes('案例') && type === 'case') {
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else if (btn.textContent.includes('团队') && type === 'team') {
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-100', 'text-gray-600');
                }
            });
            
            const materials = document.querySelectorAll('#companyMaterialsList > div');
            materials.forEach(material => {
                if (type === 'all' || material.dataset.type === type) {
                    material.style.display = 'block';
                } else {
                    material.style.display = 'none';
                }
            });
        }
        
        function applyFormat(formatType) {
            const editor = document.getElementById('chapterContent');
            if (!window.currentChapterId) {
                showToast('请先选择章节', 'warning');
                return;
            }
            
            let message = '';
            if (formatType === 'font') {
                message = '字体已修复为三号仿宋';
            } else if (formatType === 'spacing') {
                message = '行距已调整';
            } else if (formatType === 'header') {
                message = '页眉页脚模板已套用';
            }
            
            showToast(message, 'success');
            closeToolPanel('format');
        }
        
        function generateImage() {
            const prompt = document.getElementById('imagePrompt').value;
            const style = document.getElementById('imageStyle').value;
            
            if (!prompt.trim()) {
                showToast('请输入图片描述', 'warning');
                return;
            }
            
            const btn = document.getElementById('generateImageBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 生成中...';
            
            // 模拟生成过程
            setTimeout(() => {
                document.getElementById('imagePreview').classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = originalText;
                showToast('图片生成完成', 'success');
            }, 2000);
        }
        
        function insertGeneratedImage() {
            const prompt = document.getElementById('imagePrompt').value;
            const editor = document.getElementById('chapterContent');
            if (!window.currentChapterId) {
                showToast('请先选择章节', 'warning');
                return;
            }
            const cursorPos = editor.selectionStart;
            const textBefore = editor.value.substring(0, cursorPos);
            const textAfter = editor.value.substring(cursorPos);
            editor.value = textBefore + `\n[AI生成图片: ${prompt}]\n` + textAfter;
            updateChapterContent();
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imagePrompt').value = '';
            closeToolPanel('ai-image');
            showToast('图片已插入', 'success');
        }
        
        function regenerateImage() {
            document.getElementById('imagePreview').classList.add('hidden');
            generateImage();
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = {
                'success': 'bg-green-500',
                'warning': 'bg-yellow-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500'
            }[type] || 'bg-blue-500';
            
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-slide-in`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slide-out 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function insertAIContent() {
            const editor = document.getElementById('chapterContent');
            if (!window.currentChapterId) {
                showToast('请先选择章节', 'warning');
                return;
            }
            showAIModal('generate');
        }
        
        function rewriteContent() {
            const editor = document.getElementById('chapterContent');
            const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            if (!selectedText.trim() && editor.value.trim() === '') {
                showToast('请先选择或输入要重写的内容', 'warning');
                return;
            }
            showAIModal('rewrite', selectedText);
        }
        
        function expandContent() {
            const editor = document.getElementById('chapterContent');
            const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            if (!selectedText.trim() && editor.value.trim() === '') {
                showToast('请先选择或输入要扩写的内容', 'warning');
                return;
            }
            showAIModal('expand', selectedText);
        }
        
        function polishContent() {
            const editor = document.getElementById('chapterContent');
            const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            if (!selectedText.trim() && editor.value.trim() === '') {
                showToast('请先选择或输入要润色的内容', 'warning');
                return;
            }
            showAIModal('polish', selectedText);
        }
        
        function showAIModal(mode, selectedText = '') {
            const modal = document.getElementById('aiModal');
            const modeText = {
                'generate': 'AI生成内容',
                'rewrite': 'AI重写',
                'expand': 'AI扩写',
                'polish': 'AI润色'
            };
            
            document.getElementById('aiModalTitle').textContent = modeText[mode];
            document.getElementById('aiPromptInput').value = selectedText || '';
            document.getElementById('aiPromptInput').placeholder = mode === 'generate' ? '描述您要生成的内容，例如：项目概述、技术方案等...' : '可以补充具体要求，或直接生成';
            document.getElementById('aiModalMode').value = mode;
            
            // 同步知识库列表
            const knowledgeList = document.getElementById('knowledgeList');
            const aiKnowledgeList = document.getElementById('aiKnowledgeList');
            aiKnowledgeList.innerHTML = knowledgeList.innerHTML;
            
            modal.classList.remove('hidden');
        }
        
        function closeAIModal() {
            document.getElementById('aiModal').classList.add('hidden');
        }
        
        // 导出功能
        function showExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
            // 初始化格式选择
            initExportFormatSelection();
        }
        
        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }
        
        function initExportFormatSelection() {
            const formatOptions = document.querySelectorAll('.export-format-option');
            const description = document.getElementById('exportDescription');
            
            // 移除之前的事件监听器（如果存在）
            formatOptions.forEach(option => {
                const newOption = option.cloneNode(true);
                option.parentNode.replaceChild(newOption, option);
            });
            
            // 重新获取选项
            const updatedOptions = document.querySelectorAll('.export-format-option');
            
            updatedOptions.forEach(option => {
                const radio = option.querySelector('input[type="radio"]');
                const checkIcon = option.querySelector('.fa-check-circle');
                
                // 点击选项
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    // 取消所有选中状态
                    updatedOptions.forEach(opt => {
                        opt.classList.remove('border-blue-500', 'bg-blue-50');
                        opt.classList.add('border-gray-200');
                        const icon = opt.querySelector('.fa-check-circle');
                        if (icon) icon.classList.add('hidden');
                        const radioBtn = opt.querySelector('input[type="radio"]');
                        if (radioBtn) radioBtn.checked = false;
                    });
                    
                    // 设置当前选中
                    option.classList.remove('border-gray-200');
                    option.classList.add('border-blue-500', 'bg-blue-50');
                    if (checkIcon) checkIcon.classList.remove('hidden');
                    if (radio) radio.checked = true;
                    
                    // 更新说明文字
                    if (radio && radio.value === 'word') {
                        if (description) description.textContent = 'Word格式支持后续编辑，保留所有格式和样式。';
                    } else if (radio && radio.value === 'pdf') {
                        if (description) description.textContent = 'PDF格式适合最终交付，不可编辑，保持格式一致性。';
                    }
                });
            });
            
            // 默认选中Word
            const wordOption = document.querySelector('.export-format-option[data-format="word"]');
            if (wordOption) {
                const wordRadio = wordOption.querySelector('input[type="radio"]');
                const wordCheckIcon = wordOption.querySelector('.fa-check-circle');
                if (wordRadio) wordRadio.checked = true;
                wordOption.classList.remove('border-gray-200');
                wordOption.classList.add('border-blue-500', 'bg-blue-50');
                if (wordCheckIcon) wordCheckIcon.classList.remove('hidden');
                if (description) description.textContent = 'Word格式支持后续编辑，保留所有格式和样式。';
            }
        }
        
        function executeExport() {
            const selectedFormat = document.querySelector('input[name="exportFormat"]:checked');
            if (!selectedFormat) {
                showToast('请选择导出格式', 'warning');
                return;
            }
            
            const format = selectedFormat.value;
            const formatName = format === 'word' ? 'Word' : 'PDF';
            
            // 显示加载状态
            const exportBtn = document.querySelector('#exportModal button[onclick="executeExport()"]');
            if (exportBtn) {
                const originalText = exportBtn.innerHTML;
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 导出中...';
                
                // 模拟导出过程
                setTimeout(() => {
                    closeExportModal();
                    showToast(`${formatName}格式标书导出成功！`, 'success');
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalText;
                    
                    // 模拟下载（实际应该调用后端API）
                    const fileName = `城市运行数字底座建设项目投标书.${format === 'word' ? 'docx' : 'pdf'}`;
                    console.log(`导出文件：${fileName}`);
                    // 实际项目中这里应该触发文件下载
                    // window.location.href = `/api/export?format=${format}&filename=${fileName}`;
                }, 2000);
            } else {
                closeExportModal();
                showToast(`${formatName}格式标书导出成功！`, 'success');
            }
        }
        
        function executeAIAction() {
            const mode = document.getElementById('aiModalMode').value;
            const prompt = document.getElementById('aiPromptInput').value;
            const editor = document.getElementById('chapterContent');
            
            if (!window.currentChapterId) {
                showToast('请先选择章节', 'warning');
                return;
            }
            
            // 显示加载状态
            const generateBtn = document.getElementById('aiGenerateBtn');
            const originalText = generateBtn.innerHTML;
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 生成中...';
            
            // 模拟AI生成
            setTimeout(() => {
                const cursorPos = editor.selectionStart;
                const textBefore = editor.value.substring(0, cursorPos);
                const textAfter = editor.value.substring(cursorPos);
                
                let generatedContent = '';
                if (mode === 'generate') {
                    generatedContent = `\n\n【${prompt || 'AI生成内容'}】\n本项目采用先进的技术架构，确保系统的高性能、高可用性和可扩展性。通过模块化设计，实现了业务逻辑的清晰分离，便于后续维护和升级。\n\n`;
                } else if (mode === 'rewrite') {
                    generatedContent = `\n\n【重写后的内容】\n${prompt || '已重写的内容将显示 here'}\n\n`;
                } else if (mode === 'expand') {
                    generatedContent = `\n\n【扩写后的内容】\n${prompt || '已扩写的内容将显示 here'}\n\n`;
                } else if (mode === 'polish') {
                    generatedContent = `\n\n【润色后的内容】\n${prompt || '已润色的内容将显示 here'}\n\n`;
                }
                
                editor.value = textBefore + generatedContent + textAfter;
                editor.focus();
                editor.setSelectionRange(cursorPos + generatedContent.length, cursorPos + generatedContent.length);
                
                updateChapterContent();
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalText;
                closeAIModal();
                showToast('内容已生成并插入', 'success');
            }, 2000);
        }
        // 存储已选择的知识库和文件
        window.selectedKnowledgeFiles = {
            '智慧城市项目案例库': ['智慧城市数字底座项目案例.docx']
        }; // { "知识库名": ["文件1", "文件2"], ... }
        
        function showKnowledgeModal() {
            // 恢复之前的选择状态
            restoreKnowledgeSelection();
            // 清空搜索框
            const searchInput = document.getElementById('knowledgeSearchInput');
            if (searchInput) {
                searchInput.value = '';
                clearKnowledgeSearch();
            }
            document.getElementById('knowledgeModal').classList.remove('hidden');
        }
        
        function closeKnowledgeModal() {
            document.getElementById('knowledgeModal').classList.add('hidden');
        }
        
        function toggleKnowledgeFiles(knowledgeId) {
            const filesDiv = document.getElementById(knowledgeId);
            const icon = document.getElementById('icon-' + knowledgeId);
            if (filesDiv.classList.contains('hidden')) {
                filesDiv.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                filesDiv.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        function toggleAllFiles(knowledgeId, checked) {
            const knowledgeName = document.querySelector(`#${knowledgeId}`).closest('.border').querySelector('.knowledge-checkbox').dataset.knowledge;
            const checkboxes = document.querySelectorAll(`#${knowledgeId} .file-checkbox[data-knowledge="${knowledgeName}"]`);
            checkboxes.forEach(cb => {
                cb.checked = checked;
            });
            updateKnowledgeSelection();
        }
        
        function updateKnowledgeSelection() {
            // 更新全选复选框状态
            document.querySelectorAll('.knowledge-checkbox').forEach(kbCheckbox => {
                const knowledgeName = kbCheckbox.dataset.knowledge;
                const knowledgeId = kbCheckbox.closest('.border').querySelector('[id^="knowledge-"]').id;
                const fileCheckboxes = document.querySelectorAll(`#${knowledgeId} .file-checkbox[data-knowledge="${knowledgeName}"]`);
                const checkedFiles = Array.from(fileCheckboxes).filter(cb => cb.checked);
                kbCheckbox.checked = fileCheckboxes.length > 0 && checkedFiles.length === fileCheckboxes.length;
                kbCheckbox.indeterminate = checkedFiles.length > 0 && checkedFiles.length < fileCheckboxes.length;
            });
        }
        
        function confirmKnowledgeSelection() {
            // 收集所有选中的文件
            window.selectedKnowledgeFiles = {};
            document.querySelectorAll('.file-checkbox:checked').forEach(checkbox => {
                const knowledgeName = checkbox.dataset.knowledge;
                const fileName = checkbox.dataset.file;
                if (!window.selectedKnowledgeFiles[knowledgeName]) {
                    window.selectedKnowledgeFiles[knowledgeName] = [];
                }
                window.selectedKnowledgeFiles[knowledgeName].push(fileName);
            });
            
            // 更新显示
            renderKnowledgeList();
            closeKnowledgeModal();
            showToast('知识库文件已选择', 'success');
            // 自动保存
            saveToLocalStorage();
        }
        
        function renderKnowledgeList() {
            const list = document.getElementById('knowledgeList');
            list.innerHTML = '';
            
            Object.keys(window.selectedKnowledgeFiles).forEach(knowledgeName => {
                const files = window.selectedKnowledgeFiles[knowledgeName];
                if (files.length === 0) return;
                
                // 如果选择了该知识库的所有文件或文件数量较多，显示知识库名
                if (files.length >= 3) {
                    const span = document.createElement('span');
                    span.className = 'px-2 py-1 bg-white border border-blue-200 rounded text-xs text-blue-700 flex items-center gap-1';
                    span.innerHTML = `${knowledgeName} (${files.length}个文件) <i class="fas fa-times ml-1 cursor-pointer hover:text-red-600" onclick="removeKnowledge('${knowledgeName}', null)"></i>`;
                    list.appendChild(span);
                } else {
                    // 显示具体文件
                    files.forEach(fileName => {
                        const span = document.createElement('span');
                        span.className = 'px-2 py-1 bg-white border border-blue-200 rounded text-xs text-blue-700 flex items-center gap-1';
                        span.innerHTML = `<span class="text-gray-500">${knowledgeName}/</span>${fileName} <i class="fas fa-times ml-1 cursor-pointer hover:text-red-600" onclick="removeKnowledge('${knowledgeName}', '${fileName}')"></i>`;
                        list.appendChild(span);
                    });
                }
            });
            
            // 同步到AI模态框
            const aiKnowledgeList = document.getElementById('aiKnowledgeList');
            if (aiKnowledgeList) {
                aiKnowledgeList.innerHTML = list.innerHTML;
            }
        }
        
        function removeKnowledge(knowledgeName, fileName) {
            if (fileName === null) {
                // 删除整个知识库
                delete window.selectedKnowledgeFiles[knowledgeName];
            } else {
                // 删除单个文件
                if (window.selectedKnowledgeFiles[knowledgeName]) {
                    window.selectedKnowledgeFiles[knowledgeName] = window.selectedKnowledgeFiles[knowledgeName].filter(f => f !== fileName);
                    if (window.selectedKnowledgeFiles[knowledgeName].length === 0) {
                        delete window.selectedKnowledgeFiles[knowledgeName];
                    }
                }
            }
            renderKnowledgeList();
        }
        
        function restoreKnowledgeSelection() {
            // 恢复之前的选择状态
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                const knowledgeName = checkbox.dataset.knowledge;
                const fileName = checkbox.dataset.file;
                if (window.selectedKnowledgeFiles[knowledgeName] && window.selectedKnowledgeFiles[knowledgeName].includes(fileName)) {
                    checkbox.checked = true;
                } else {
                    checkbox.checked = false;
                }
            });
            updateKnowledgeSelection();
        }
        
        function searchKnowledgeFiles(keyword) {
            const clearBtn = document.getElementById('clearSearchBtn');
            const resultCount = document.getElementById('searchResultCount');
            const countText = document.getElementById('matchCount');
            
            // 显示/隐藏清除按钮
            if (!keyword || keyword.trim() === '') {
                if (clearBtn) clearBtn.classList.add('hidden');
                if (resultCount) resultCount.classList.add('hidden');
                // 清除搜索，显示所有
                clearKnowledgeSearch();
                return;
            } else {
                if (clearBtn) clearBtn.classList.remove('hidden');
                if (resultCount) resultCount.classList.remove('hidden');
            }
            
            keyword = keyword.toLowerCase().trim();
            let matchCount = 0;
            
            // 遍历所有知识库
            document.querySelectorAll('.knowledge-item').forEach(knowledgeItem => {
                const knowledgeName = knowledgeItem.dataset.knowledgeName;
                const knowledgeNameElement = knowledgeItem.querySelector('.font-medium');
                const filesContainer = knowledgeItem.querySelector('[id^="knowledge-"]');
                const fileCheckboxes = knowledgeItem.querySelectorAll('.file-checkbox');
                
                let knowledgeMatch = knowledgeName && knowledgeName.toLowerCase().includes(keyword);
                let hasMatchingFile = false;
                let fileMatchCount = 0;
                
                // 检查文件是否匹配
                fileCheckboxes.forEach(checkbox => {
                    const fileName = checkbox.dataset.file;
                    const label = checkbox.closest('label');
                    const fileNameElement = label ? label.querySelector('.text-xs.text-gray-700') : null;
                    
                    if (fileName && fileName.toLowerCase().includes(keyword)) {
                        hasMatchingFile = true;
                        fileMatchCount++;
                        // 显示匹配的文件
                        if (label) label.style.display = 'flex';
                        // 高亮匹配的文本
                        if (fileNameElement) {
                            highlightText(fileNameElement, keyword);
                        }
                    } else {
                        // 隐藏不匹配的文件
                        if (label) label.style.display = 'none';
                    }
                });
                
                // 如果知识库名称匹配或有匹配的文件，显示知识库
                if (knowledgeMatch || hasMatchingFile) {
                    knowledgeItem.style.display = 'block';
                    matchCount += fileMatchCount;
                    if (knowledgeMatch) matchCount++;
                    
                    // 如果有匹配的文件，自动展开
                    if (hasMatchingFile && filesContainer && filesContainer.classList.contains('hidden')) {
                        filesContainer.classList.remove('hidden');
                        const icon = knowledgeItem.querySelector('[id^="icon-"]');
                        if (icon) icon.style.transform = 'rotate(180deg)';
                    }
                    // 高亮知识库名称
                    if (knowledgeMatch && knowledgeNameElement) {
                        highlightText(knowledgeNameElement, keyword);
                    }
                } else {
                    // 隐藏不匹配的知识库
                    knowledgeItem.style.display = 'none';
                }
            });
            
            // 更新匹配计数
            if (countText) countText.textContent = matchCount;
        }
        
        function highlightText(element, keyword) {
            if (!element || !keyword) return;
            // 如果已经高亮过，先恢复原始文本
            if (element.dataset.originalText) {
                element.textContent = element.dataset.originalText;
            } else {
                element.dataset.originalText = element.textContent;
            }
            const originalText = element.textContent;
            // 转义特殊字符
            const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedKeyword})`, 'gi');
            const highlightedText = originalText.replace(regex, '<mark class="bg-yellow-200 text-yellow-900">$1</mark>');
            element.innerHTML = highlightedText;
        }
        
        function goBack() {
            try {
                // 先保存当前内容
                saveToLocalStorage();
                
                // 尝试返回到标书制作页面（如果在iframe中）
                if (window.parent && window.parent !== window) {
                    // 如果在标书制作页面的iframe中，切换到招标解读步骤
                    if (window.parent.document) {
                        const step1Btn = window.parent.document.querySelector('.step-tab[onclick*="step1"]');
                        if (step1Btn) {
                            step1Btn.click();
                            return;
                        }
                    }
                    // 如果无法切换步骤，返回到标书工厂
                    if (window.parent.loadPage) {
                        window.parent.loadPage('标书工厂.html', 'top');
                        return;
                    }
                }
                // 直接跳转到标书工厂
                window.location.href = '标书工厂.html';
            } catch (e) {
                console.error('返回失败:', e);
                window.location.href = '标书工厂.html';
            }
        }
        
        function clearKnowledgeSearch() {
            const searchInput = document.getElementById('knowledgeSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // 恢复所有元素的显示
            document.querySelectorAll('.knowledge-item').forEach(item => {
                item.style.display = 'block';
            });
            
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                const label = checkbox.closest('label');
                if (label) label.style.display = 'flex';
            });
            
            // 恢复原始文本（移除高亮）
            document.querySelectorAll('.font-medium, .text-xs.text-gray-700').forEach(element => {
                if (element.dataset.originalText) {
                    element.textContent = element.dataset.originalText;
                    element.removeAttribute('data-original-text');
                } else if (element.innerHTML.includes('<mark>')) {
                    element.textContent = element.textContent || element.innerText;
                }
            });
            
            // 隐藏清除按钮和结果计数
            const clearBtn = document.getElementById('clearSearchBtn');
            const resultCount = document.getElementById('searchResultCount');
            if (clearBtn) clearBtn.classList.add('hidden');
            if (resultCount) resultCount.classList.add('hidden');
        }

        // AI对话助手功能
        let chatPanelCollapsed = false; // 默认展开
        let chatMessages = [];

        function toggleChatPanel() {
            const chatContent = document.getElementById('chatContent');
            const toggleBtn = document.getElementById('chatToggleBtn');
            const icon = toggleBtn.querySelector('i');
            
            chatPanelCollapsed = !chatPanelCollapsed;
            
            if (chatPanelCollapsed) {
                chatContent.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                chatContent.style.display = 'flex';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                // 自动滚动到底部
                setTimeout(() => {
                    const messagesContainer = document.getElementById('chatMessages');
                    if (messagesContainer) {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }, 100);
            }
        }
        
        // 确保AI助手容器高度自适应
        window.addEventListener('load', function() {
            const chatContainer = document.querySelector('.w-80');
            if (chatContainer) {
                // 设置高度为视口高度减去一些padding
                const setChatHeight = () => {
                    const section = document.querySelector('section.p-6');
                    const sectionTop = section ? section.offsetTop : 0;
                    const availableHeight = window.innerHeight - sectionTop - 48; // 减去padding
                    chatContainer.style.height = availableHeight + 'px';
                };
                setChatHeight();
                window.addEventListener('resize', setChatHeight);
            }
        });

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            if (!window.currentChapterId) {
                showToast('请先选择章节', 'warning');
                return;
            }

            // 检查是否有@章节引用
            const atMentions = message.match(/@[^@\s]+/g);
            let processedMessage = message;
            
            if (atMentions) {
                // 提取@的章节名称，可以在处理时使用
                atMentions.forEach(mention => {
                    const chapterName = mention.substring(1);
                    // 可以在这里添加章节引用的处理逻辑
                });
            }

            // 添加用户消息
            addChatMessage('user', message);
            input.value = '';

            // 显示AI思考中
            const thinkingId = addChatMessage('ai', '', true);

            // 模拟AI处理（实际应该调用后端API）
            setTimeout(() => {
                processChatRequest(message, thinkingId);
            }, 1000);
        }

        function addChatMessage(role, content, isThinking = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `flex gap-2 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            if (isThinking) {
                messageDiv.innerHTML = `
                    <div class="w-5 h-5 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center flex-shrink-0 text-[10px]">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="flex-1">
                        <div class="bg-gray-50 rounded-lg ${role === 'user' ? 'rounded-tr-none' : 'rounded-tl-none'} p-2 text-gray-500">
                            <div class="flex items-center gap-1">
                                <span class="typing-indicator"></span>
                                <span class="typing-indicator"></span>
                                <span class="typing-indicator"></span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-5 h-5 rounded-full ${role === 'user' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600'} flex items-center justify-center flex-shrink-0 text-[10px]">
                        <i class="fas ${role === 'user' ? 'fa-user' : 'fa-robot'}"></i>
                    </div>
                    <div class="flex-1">
                        <div class="bg-${role === 'user' ? 'purple' : 'gray'}-50 rounded-lg ${role === 'user' ? 'rounded-tr-none' : 'rounded-tl-none'} p-2 text-gray-700">
                            ${content}
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            chatMessages.push({ role, content, id: messageId });
            return messageId;
        }

        function updateChatMessage(messageId, content, showActions = false) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;

            const contentDiv = messageDiv.querySelector('.bg-gray-50, .bg-purple-50');
            if (contentDiv) {
                contentDiv.className = contentDiv.className.replace(/bg-\w+-50/, 'bg-gray-50');
                contentDiv.innerHTML = content;
                
                if (showActions) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'mt-2 flex gap-2';
                    actionsDiv.innerHTML = `
                        <button onclick="applyChatSuggestion('${messageId}')" class="px-2 py-1 bg-blue-600 text-white rounded text-[10px] hover:bg-blue-700">
                            <i class="fas fa-check mr-1"></i>应用修改
                        </button>
                        <button onclick="regenerateChatSuggestion('${messageId}')" class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-[10px] hover:bg-gray-200">
                            <i class="fas fa-redo mr-1"></i>重新生成
                        </button>
                    `;
                    contentDiv.appendChild(actionsDiv);
                }
            }
        }

        function processChatRequest(userMessage, thinkingId) {
            const editor = document.getElementById('chapterContent');
            const currentContent = editor.value || '';
            const chapterTitle = document.getElementById('currentChapter').textContent;

            // 简单的意图识别（实际应该使用更复杂的NLP）
            let response = '';
            let modifiedContent = '';
            let shouldModify = false;

            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('改') || lowerMessage.includes('修改') || lowerMessage.includes('调整')) {
                shouldModify = true;
                if (lowerMessage.includes('专业') || lowerMessage.includes('正式')) {
                    modifiedContent = currentContent.replace(/。/g, '。').replace(/，/g, '，');
                    modifiedContent = modifiedContent.split('\n').map(line => {
                        if (line.trim()) {
                            return line.trim() + '。';
                        }
                        return line;
                    }).join('\n');
                    response = '已为您将内容调整为更专业的表达方式：';
                } else if (lowerMessage.includes('简洁') || lowerMessage.includes('简短')) {
                    modifiedContent = currentContent.split('\n').filter(line => line.trim().length > 10).join('\n');
                    response = '已为您精简内容，保留核心要点：';
                } else if (lowerMessage.includes('详细') || lowerMessage.includes('补充')) {
                    modifiedContent = currentContent + '\n\n【补充说明】\n' + 
                        '本项目在实施过程中，将严格按照相关技术标准和规范执行，确保项目质量和进度。';
                    response = '已为您补充详细说明：';
                } else {
                    // 通用修改
                    modifiedContent = currentContent + '\n\n【已优化】\n' + 
                        '以上内容已根据您的要求进行调整和优化。';
                    response = '已根据您的要求修改内容：';
                }
            } else if (lowerMessage.includes('检查') || lowerMessage.includes('审查')) {
                response = '检查结果：\n• 内容结构完整\n• 符合标书格式要求\n• 建议补充更多技术细节';
                shouldModify = false;
            } else if (lowerMessage.includes('建议') || lowerMessage.includes('推荐')) {
                response = '建议：\n• 可以增加项目亮点描述\n• 建议补充实施时间表\n• 可添加风险控制措施说明';
                shouldModify = false;
            } else {
                // 默认回复
                response = '我理解您的需求。针对当前章节"' + chapterTitle + '"，我可以帮您：\n• 修改和优化内容\n• 调整语气和表达方式\n• 补充技术细节\n• 检查格式规范\n\n请告诉我具体需要如何调整？';
                shouldModify = false;
            }

            // 更新消息
            if (shouldModify && modifiedContent) {
                updateChatMessage(thinkingId, response + '\n\n```\n' + modifiedContent.substring(0, 200) + (modifiedContent.length > 200 ? '...' : '') + '\n```', true);
                // 保存建议的内容到消息数据中
                const msg = chatMessages.find(m => m.id === thinkingId);
                if (msg) {
                    msg.suggestedContent = modifiedContent;
                }
            } else {
                updateChatMessage(thinkingId, response, false);
            }
        }

        function applyChatSuggestion(messageId) {
            const message = chatMessages.find(m => m.id === messageId);
            if (!message || !message.suggestedContent) {
                showToast('未找到可应用的内容', 'warning');
                return;
            }

            const editor = document.getElementById('chapterContent');
            editor.value = message.suggestedContent;
            updateChapterContent();
            showToast('内容已应用', 'success');
            
            // 添加确认消息
            addChatMessage('ai', '✓ 修改已应用到当前章节内容中');
        }

        function regenerateChatSuggestion(messageId) {
            const message = chatMessages.find(m => m.id === messageId);
            if (!message) return;

            // 找到对应的用户消息
            const userMsgIndex = chatMessages.findIndex(m => m.id === messageId) - 1;
            if (userMsgIndex >= 0 && chatMessages[userMsgIndex].role === 'user') {
                const userMessage = chatMessages[userMsgIndex].content;
                updateChatMessage(messageId, '', true);
                setTimeout(() => {
                    processChatRequest(userMessage, messageId);
                }, 500);
            }
        }

        // 章节选择器功能
        function showChapterSelector() {
            const modal = document.getElementById('chapterSelectorModal');
            const list = document.getElementById('chapterSelectorList');
            
            // 生成章节列表
            list.innerHTML = '';
            if (!window.catalogData || window.catalogData.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 py-4 text-xs">暂无章节</p>';
            } else {
                window.catalogData.forEach(chapter => {
                    const chapterItem = document.createElement('div');
                    chapterItem.className = 'p-2 hover:bg-gray-50 rounded cursor-pointer';
                    chapterItem.onclick = () => selectChapterForChat(chapter.id, chapter.title);
                    chapterItem.innerHTML = `
                        <div class="flex items-center gap-2">
                            <i class="fas fa-file-alt text-gray-400 text-xs"></i>
                            <span class="text-gray-700">${chapter.title}</span>
                        </div>
                    `;
                    list.appendChild(chapterItem);
                    
                    // 添加子章节
                    if (chapter.children && chapter.children.length > 0) {
                        chapter.children.forEach(sub => {
                            const subItem = document.createElement('div');
                            subItem.className = 'p-2 pl-6 hover:bg-gray-50 rounded cursor-pointer';
                            subItem.onclick = () => selectChapterForChat(sub.id, sub.title);
                            subItem.innerHTML = `
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-file text-gray-400 text-[10px]"></i>
                                    <span class="text-gray-700">${sub.title}</span>
                                </div>
                            `;
                            list.appendChild(subItem);
                        });
                    }
                });
            }
            
            modal.classList.remove('hidden');
        }

        function closeChapterSelector() {
            document.getElementById('chapterSelectorModal').classList.add('hidden');
            document.getElementById('chapterSearchInput').value = '';
        }

        function selectChapterForChat(chapterId, chapterTitle) {
            const input = document.getElementById('chatInput');
            const currentText = input.value;
            const cursorPos = input.selectionStart || currentText.length;
            
            // 插入@章节引用
            const beforeText = currentText.substring(0, cursorPos);
            const afterText = currentText.substring(cursorPos);
            const mention = `@${chapterTitle} `;
            
            input.value = beforeText + mention + afterText;
            input.focus();
            input.setSelectionRange(cursorPos + mention.length, cursorPos + mention.length);
            
            closeChapterSelector();
        }

        function searchChapters(keyword) {
            const items = document.querySelectorAll('#chapterSelectorList > div');
            keyword = keyword.toLowerCase().trim();
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(keyword) || keyword === '') {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // 资源面板功能
        function showResourcePanel() {
            document.getElementById('resourcePanel').classList.remove('hidden');
            // 清空搜索框
            document.getElementById('resourceSearchInput').value = '';
            resourceSearchKeyword = '';
            switchResourceTab('image');
        }

        function closeResourcePanel() {
            document.getElementById('resourcePanel').classList.add('hidden');
        }

        // 资源面板相关变量
        let currentResourceTab = 'image';
        let resourceSearchKeyword = '';

        // 从资源资产库读取数据
        function loadResourceDataFromLibrary() {
            try {
                const saved = localStorage.getItem('resource_asset_library');
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('加载资源数据失败:', e);
            }
            // 返回默认空数据
            return {
                image: [],
                material: [],
                case: [],
                knowledge: [],
                certificate: [],
                template: []
            };
        }

        // 获取资源库名称
        function getCategoryName(category) {
            const names = {
                image: '图片库',
                material: '企业素材库',
                case: '企业案例库',
                knowledge: '行业知识库',
                certificate: '资质证件',
                template: '标书模板'
            };
            return names[category] || category;
        }

        // 获取资源图标
        function getCategoryIcon(category) {
            const icons = {
                image: 'fa-images',
                material: 'fa-folder-open',
                case: 'fa-briefcase',
                knowledge: 'fa-book',
                certificate: 'fa-certificate',
                template: 'fa-file-alt'
            };
            return icons[category] || 'fa-file';
        }

        function switchResourceTab(tab) {
            currentResourceTab = tab;
            
            // 更新按钮状态
            document.querySelectorAll('.resource-tab-btn').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.classList.remove('bg-gray-100', 'text-gray-700');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-100', 'text-gray-700');
                }
            });

            // 重新渲染内容（会应用当前搜索关键词）
            renderResourceContent();
        }

        // 搜索资源
        function searchResourcesInPanel() {
            resourceSearchKeyword = document.getElementById('resourceSearchInput').value.trim().toLowerCase();
            renderResourceContent();
        }

        // 渲染资源内容
        function renderResourceContent() {
            const content = document.getElementById('resourceContent');
            const resourceData = loadResourceDataFromLibrary();
            const resources = resourceData[currentResourceTab] || [];
            
            // 过滤资源（根据搜索关键词）
            let filteredResources = resources;
            if (resourceSearchKeyword) {
                filteredResources = resources.filter(resource => {
                    const name = (resource.name || '').toLowerCase();
                    const description = (resource.description || '').toLowerCase();
                    const tags = (resource.tags || []).join(' ').toLowerCase();
                    const searchText = name + ' ' + description + ' ' + tags;
                    return searchText.includes(resourceSearchKeyword);
                });
            }

            if (filteredResources.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p class="text-sm">${resourceSearchKeyword ? '未找到匹配的资源' : '暂无资源'}</p>
                        ${!resourceSearchKeyword ? `<p class="text-xs mt-1">请前往"资源资产库"添加资源</p>` : ''}
                    </div>
                `;
                return;
            }

            // 根据资源类型渲染不同样式
            if (currentResourceTab === 'image') {
                // 图片库：网格布局
                content.innerHTML = `
                    <div class="grid grid-cols-3 gap-4">
                        ${filteredResources.map(resource => `
                            <div class="aspect-square bg-gradient-to-br from-blue-100 to-blue-200 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-2 hover:border-blue-500 border-2 border-transparent p-3" 
                                 onclick="insertResource('${currentResourceTab}', '${(resource.name || '').replace(/'/g, "\\'")}', '${(resource.file || '').replace(/'/g, "\\'")}')"
                                 title="${(resource.name || '').replace(/"/g, '&quot;')}">
                                <i class="fas ${getCategoryIcon(currentResourceTab)} text-2xl text-blue-600 mb-2"></i>
                                <span class="text-xs text-blue-700 text-center truncate w-full">${resource.name || '未命名'}</span>
                                ${resource.description ? `<span class="text-[10px] text-blue-500 mt-1 text-center line-clamp-2">${resource.description}</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                // 其他库：列表布局
                content.innerHTML = `
                    <div class="space-y-2">
                        ${filteredResources.map(resource => `
                            <div class="p-3 border border-gray-100 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition" 
                                 onclick="insertResource('${currentResourceTab}', '${(resource.name || '').replace(/'/g, "\\'")}', '${(resource.file || '').replace(/'/g, "\\'")}')">
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="fas ${getCategoryIcon(currentResourceTab)} text-blue-600"></i>
                                    <p class="font-medium text-sm text-gray-800">${resource.name || '未命名'}</p>
                                    ${resource.file ? `<span class="text-xs text-gray-400 ml-auto">${resource.file}</span>` : ''}
                                </div>
                                ${resource.description ? `<p class="text-xs text-gray-500 mb-1">${resource.description}</p>` : ''}
                                ${resource.tags && resource.tags.length > 0 ? `
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        ${resource.tags.map(tag => `<span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-[10px]">${tag}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function insertResource(category, name, file) {
            const editor = document.getElementById('chapterContent');
            if (!window.currentChapterId) {
                showToast('请先选择章节', 'warning');
                return;
            }

            let insertText = '';
            const categoryName = getCategoryName(category);
            
            if (category === 'image') {
                insertText = `\n[图片: ${name}${file ? ` (${file})` : ''}]\n`;
            } else if (category === 'certificate') {
                insertText = `\n[资质证件: ${name}${file ? ` (${file})` : ''}]\n`;
            } else if (category === 'case') {
                insertText = `\n[案例: ${name}${file ? ` (${file})` : ''}]\n`;
            } else if (category === 'knowledge') {
                insertText = `\n[知识库: ${name}${file ? ` (${file})` : ''}]\n`;
            } else if (category === 'material') {
                insertText = `\n[素材: ${name}${file ? ` (${file})` : ''}]\n`;
            } else if (category === 'template') {
                insertText = `\n[模板: ${name}${file ? ` (${file})` : ''}]\n`;
            } else {
                insertText = `\n[${categoryName}: ${name}${file ? ` (${file})` : ''}]\n`;
            }

            const cursorPos = editor.selectionStart || editor.value.length;
            const textBefore = editor.value.substring(0, cursorPos);
            const textAfter = editor.value.substring(cursorPos);
            editor.value = textBefore + insertText + textAfter;
            editor.focus();
            editor.setSelectionRange(cursorPos + insertText.length, cursorPos + insertText.length);
            
            updateChapterContent();
            closeResourcePanel();
            showToast('资源已插入', 'success');
        }

        // 自动生成商务内容（基于标书设置中的配置）
        function autoGenerateBusinessContent() {
            try {
                // 读取标书设置中的配置
                const savedSettings = localStorage.getItem(STORAGE_SETTINGS_KEY);
                if (!savedSettings) {
                    return; // 没有配置，不生成
                }
                
                const settings = JSON.parse(savedSettings);
                let hasGenerated = false;
                
                // 检查人员配置并生成
                if (settings.personnelConfig && settings.personnelConfig.selectedCount > 0) {
                    generatePersonnelToChapter(settings.personnelConfig);
                    hasGenerated = true;
                }
                
                // 检查业绩配置并生成
                if (settings.performanceConfig && settings.performanceConfig.selectedCount > 0) {
                    generatePerformanceToChapter(settings.performanceConfig);
                    hasGenerated = true;
                }
                
                // 检查资质配置并生成
                if (settings.qualificationConfig && Array.isArray(settings.qualificationConfig)) {
                    const checkedQuals = settings.qualificationConfig.filter(q => q.checked);
                    if (checkedQuals.length > 0) {
                        generateQualificationToChapter(checkedQuals);
                        hasGenerated = true;
                    }
                }
                
                if (hasGenerated) {
                    console.log('已自动生成商务内容');
                    // 保存生成的内容
                    saveToLocalStorage();
                }
            } catch (e) {
                console.error('自动生成商务内容失败:', e);
            }
        }
        
        // 生成人员配置到对应章节
        function generatePersonnelToChapter(config) {
            const chapterId = findChapterByKeyword(['人员', '团队', '5.3']);
            if (chapterId) {
                const content = `\n\n【项目团队人员配置】\n\n根据招标文件要求，我公司配置项目团队人员如下：\n\n总人数：${config.selectedCount}人\n驻场人员：${config.onsiteCount || 0}人\n\n（具体人员信息及证明材料见附件）\n\n`;
                appendToChapter(chapterId, content);
            }
        }
        
        // 生成业绩列表到对应章节
        function generatePerformanceToChapter(config) {
            const chapterId = findChapterByKeyword(['业绩', '案例', '5.2']);
            if (chapterId) {
                const content = `\n\n【同类项目业绩】\n\n根据招标文件要求，我公司提供近3年同类项目业绩如下：\n\n已选择业绩：${config.selectedCount}个\n\n（具体业绩案例及证明材料见附件）\n\n`;
                appendToChapter(chapterId, content);
            }
        }
        
        // 生成资质证明到对应章节
        function generateQualificationToChapter(qualifications) {
            const chapterId = findChapterByKeyword(['资质', '资格', '5.1']);
            if (chapterId) {
                let content = `\n\n【企业资质证明】\n\n根据招标文件要求，我公司提供以下资质证明：\n\n`;
                qualifications.forEach(q => {
                    content += `• ${q.name}\n`;
                });
                content += `\n（具体资质证书见附件）\n\n`;
                appendToChapter(chapterId, content);
            }
        }
        
        // 根据关键词查找章节
        function findChapterByKeyword(keywords) {
            if (!window.catalogData) return null;
            
            const searchInChapters = (chapters) => {
                for (const chapter of chapters) {
                    // 检查主章节
                    if (keywords.some(keyword => chapter.title.includes(keyword))) {
                        return chapter.id;
                    }
                    // 检查子章节
                    if (chapter.children) {
                        for (const sub of chapter.children) {
                            if (keywords.some(keyword => sub.title.includes(keyword))) {
                                return sub.id;
                            }
                        }
                    }
                }
                return null;
            };
            
            return searchInChapters(window.catalogData);
        }
        
        // 追加内容到章节
        function appendToChapter(chapterId, content) {
            if (!window.chapterContents[chapterId]) {
                window.chapterContents[chapterId] = '';
            }
            // 如果章节已有内容，追加；否则直接设置
            if (window.chapterContents[chapterId].trim()) {
                window.chapterContents[chapterId] += content;
            } else {
                window.chapterContents[chapterId] = content;
            }
        }


        // 编辑器增强功能
        function generateChapterContent() {
            if (!window.currentChapterId) {
                showToast('请先选择章节', 'warning');
                return;
            }
            showAIModal('generate');
        }

        function expandSelectedText() {
            const editor = document.getElementById('chapterContent');
            const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            if (!selectedText.trim()) {
                showToast('请先选中要扩写的文本', 'warning');
                return;
            }
            showAIModal('expand', selectedText);
        }

        function rewriteSelectedText() {
            const editor = document.getElementById('chapterContent');
            const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            if (!selectedText.trim()) {
                showToast('请先选中要重写的文本', 'warning');
                return;
            }
            showAIModal('rewrite', selectedText);
        }

        function polishSelectedText() {
            const editor = document.getElementById('chapterContent');
            const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            if (!selectedText.trim()) {
                showToast('请先选中要润色的文本', 'warning');
                return;
            }
            showAIModal('polish', selectedText);
        }

        function referenceKnowledge() {
            showToast('知识库引用功能开发中', 'info');
        }

    </script>
</body>
</html>

